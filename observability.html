<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- Feb 18, 2025 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Improve observability in rust repositories</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="math-almeida" />
<link rel='icon' type='image/png' href='/images/favicon.png'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='preconnect' href='https://fonts.gstatic.com'>
<link href='https://code.cdn.mozilla.net/fonts/zilla-slab.css' rel='stylesheet'>
<link rel='stylesheet' href='/css/site.css?v=2' type='text/css'/>
<link rel='stylesheet' href='/css/custom.css' type='text/css'/>
<link rel='stylesheet' href='/css/syntax-coloring.css' type='text/css'/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="/"> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><header id="top" class="status">
<div class='intro'>
  <img src='/images/about/profile.png' alt='Torresmo' class='no-border'/>
  <h1>
    <span class="gray">Torresmo</span>
  </h1>
</div>

<div class='nav'>
<ul>
<li><a href='/'>Home</a>.</li>
<li><a href='https://github.com/math-almeida'>GitHub</a>.</li>
<li><a href='/about/'>About</a></li>
</ul>
</div>
</header>
<main id="content">
<h1 class="title">Improve observability in rust repositories
<br />
<span class="subtitle">Published on Jun 07, 2024 by math-almeida.</span>
</h1>

<section id="outline-container-org9f0c3ea" class="outline-2">
<h2 id="org9f0c3ea">Overview</h2>
<div class="outline-text-2" id="text-org9f0c3ea">
<p>
In complex systems, such as distributed software and cloud infrastructures, understanding how the system is behaving can be a challenge.
Observability allows us to understand a system from the outside, allowing us to ask questions about that system without knowing its inner workings.
Furthermore, it allows us to easily solve and deal with new problems (ie. “unknown unknowns”) and helps us answer the question: “Why is this happening?”
A lack of observability means there are certain states or behaviors that cannot be discerned or predicted just by looking at its outputs.
</p>
</div>
</section>

<section id="outline-container-org76f1958" class="outline-2">
<h2 id="org76f1958">Why it&rsquo;s important?</h2>
<div class="outline-text-2" id="text-org76f1958">
<p>
Even though the benefits of having Observability are apparent, many organizations do not prioritize its implementation.
The issue lies in outdated assumptions about how systems function. Your application is no longer a single entity residing within your control but a vast, ever-changing ecosystem of services, often dependent on elements you don&rsquo;t own. Failures are always present at all stages of the project and it is impossible to predict all possible failures that may occur.
</p>
</div>
</section>

<section id="outline-container-orgcc2174b" class="outline-2">
<h2 id="orgcc2174b">The pillars</h2>
<div class="outline-text-2" id="text-orgcc2174b">
<p>
Observability is based on three fundamental elements: logs, metrics and tracing, known as the three pillars of Observability.
</p>
</div>

<div id="outline-container-orgeea6676" class="outline-3">
<h3 id="orgeea6676">Logs</h3>
<div class="outline-text-3" id="text-orgeea6676">
<p>
Logs are records of events that occur within a system. They provide details about activities, errors, exceptions, and other information relevant to the functioning of the system.
</p>
</div>
</div>

<div id="outline-container-org31508ce" class="outline-3">
<h3 id="org31508ce">Tracing</h3>
<div class="outline-text-3" id="text-org31508ce">
<p>
Tracing involves tracking individual requests as they move through the entire system. This allows you to understand the path a request follows, including all interactions between the different components of the system.
</p>
</div>
</div>

<div id="outline-container-org048babb" class="outline-3">
<h3 id="org048babb">Metrics</h3>
<div class="outline-text-3" id="text-org048babb">
<p>
Metrics are quantitative measurements that provide information about the performance and behavior of a system over a given period of time. They can include information such as CPU usage, API response time, number of requests per second, among others.
</p>
</div>
</div>
</section>

<section id="outline-container-org3994de4" class="outline-2">
<h2 id="org3994de4">Core concepts</h2>
<div class="outline-text-2" id="text-org3994de4">
</div>
<div id="outline-container-orgaff6085" class="outline-3">
<h3 id="orgaff6085">Structured Log</h3>
<div class="outline-text-3" id="text-orgaff6085">
<p>
It consists of recording important events in systems in an organized and consistent way. These records follow a standardized format, facilitating analysis and extracting insights into system behavior.
</p>
</div>
</div>

<div id="outline-container-org61efc2b" class="outline-3">
<h3 id="org61efc2b">Log centralization</h3>
<div class="outline-text-3" id="text-org61efc2b">
<p>
It involves sending logs from all system components to a centralized location where they can be efficiently stored, searched, and analyzed.
</p>
</div>
</div>

<div id="outline-container-orge51483c" class="outline-3">
<h3 id="orge51483c">Distributed Tracing</h3>
<div class="outline-text-3" id="text-orge51483c">
<p>
It involves instrumenting system-wide requests to track their path as they traverse various components. This is typically done by generating unique tracking IDs that are propagated throughout the request flow.
</p>
</div>
</div>

<div id="outline-container-org9a46d42" class="outline-3">
<h3 id="org9a46d42">Metrics Collection</h3>
<div class="outline-text-3" id="text-org9a46d42">
<p>
It consists of regularly collecting performance metrics, such as CPU usage, memory usage, request response time, among others. These metrics are generally collected at regular intervals and stored for later analysis.
</p>
</div>
</div>

<div id="outline-container-org1b4bb01" class="outline-3">
<h3 id="org1b4bb01">Alerts and Corrective Actions</h3>
<div class="outline-text-3" id="text-org1b4bb01">
<p>
It consists of configuring alerts based on specific metrics or events that indicate problems or anomalies in the system. When an alert is triggered, corrective actions can be automatically taken to mitigate the issue.
</p>
</div>
</div>
</section>

<section id="outline-container-org0bc5c53" class="outline-2">
<h2 id="org0bc5c53">Observability in Rust</h2>
<div class="outline-text-2" id="text-org0bc5c53">
<p>
One amazing crate who provides APIs necessary for instrumenting libraries and applications to emit trace data is <a href="https://docs.rs/tracing/latest/tracing/">tracing</a>.
Developed by the Tokio team, it&rsquo;s fully built up from the ground for async which is perfect for web applications with Rust logs.
It uses the concept of &ldquo;spans&rdquo; which are used to record the flow of execution through a program.
</p>

<p>
You can use <code>tracing</code> to <sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>:
</p>
<ul class="org-ul">
<li>Emit distributed traces to an <a href="https://docs.rs/tracing-opentelemetry/latest/tracing_opentelemetry/">Open Telemetry</a> collector.</li>
<li>Debug your application with <a href="https://docs.rs/console-subscriber/latest/console_subscriber/">Tokio Console</a>.</li>
<li>Log to <a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/fmt/index.html">stdout</a>, <a href="https://docs.rs/tracing-appender/latest/tracing_appender/">log file</a> or <a href="https://docs.rs/tracing-journald/latest/tracing_journald/">journalId</a>.</li>
<li><a href="https://docs.rs/tracing-timing/latest/tracing_timing/">profile</a> where your application is spending time.</li>
</ul>
</div>
</section>

<section id="outline-container-orge31e8c5" class="outline-2">
<h2 id="orge31e8c5">Getting Started with Tracing</h2>
<div class="outline-text-2" id="text-orge31e8c5">
<p>
You can get started installing the crate into your project.
</p>
<div class="org-src-container">
<pre class="src src-sh">cargo add tracing
</pre>
</div>

<p>
If your program copiles to a binary (not a library), you need to install a logging subscriber.
</p>
<div class="org-src-container">
<pre class="src src-sh">cargo add tracing-subscriber
</pre>
</div>

<p>
And now we need to implement it in our project
</p>
<div class="org-src-container">
<pre class="src src-rust"><span class="org-keyword">use</span> <span class="org-constant">tracing</span>;
<span class="org-keyword">use</span> <span class="org-constant">tracing_subscriber</span>;

<span class="org-keyword">fn</span> <span class="org-function-name">main</span>() {
    <span class="org-constant">tracing</span>::<span class="org-constant">subscriber</span>::set_global_default(
        <span class="org-constant">tracing_subscriber</span>::<span class="org-type">FmtSubscriber</span>::new()
    ).expect(<span class="org-string">"setting default subscriber failed"</span>);

    <span class="org-keyword">let</span> <span class="org-variable-name">result</span> = compute(5);
    <span class="org-constant">tracing</span>::<span class="org-preprocessor">info!</span>(<span class="org-string">"The result is {}"</span>, result);
}

<span class="org-preprocessor">#[tracing::instrument(ret)]</span>
<span class="org-keyword">fn</span> <span class="org-function-name">compute</span>(<span class="org-variable-name">n</span>: <span class="org-type">i32</span>) -&gt; <span class="org-type">i32</span> {
    <span class="org-keyword">if</span> n &gt; 10 {
        <span class="org-constant">tracing</span>::<span class="org-preprocessor">warn!</span>(<span class="org-string">"The number is greater than 10"</span>);
    } <span class="org-keyword">else</span> <span class="org-keyword">if</span> n &lt; 1 {
        <span class="org-constant">tracing</span>::<span class="org-preprocessor">error!</span>(<span class="org-string">"The number is less than 1"</span>);
    }
    n * 2
}
</pre>
</div>

<p>
In the above code, we first set a default subscriber for the tracing events.
Then, we use the <code>info!</code> macro to record an event at the info level. In the compute function, we use the trace!, <code>warn!</code>, and <code>error!</code> macros to record events at different levels based on the value of n.
We also use <code>instrument</code> macro to record the return and the params of the compute function, it can be used to record errors or other fields in Span increasing even more observability.
</p>

<p>
This simple example show the power of tracing crate and how we can use it to improve observability in Rust repositories, in more complex systems we can add <code>tracing-futures</code> and <code>tracing-serde</code> to improve serializing and provides instrumenting for Futures, but I will cover this topics in another post.
</p>

<p>
Thanks for reading! 
</p>
</div>
</section>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="https://tokio.rs/tokio/topics/tracing">Tracing toping on tokio.rs</a>
</p></div></div>


</div>
</div></main>
<footer id="postamble" class="status">
<div class='footer'>
  Copyright © 2024 <a href='mailto:matheusalmeida025@gmail.com'>Matheus Almeida.</a><br>
  Template by <a href='https://gitlab.com/psachin/psachin.gitlab.io/'>Sachin Patil</a> <br>
  Last updated on Feb 18, 2025. Generated using <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.2 (<a href="https://orgmode.org">Org</a> mode 9.4.4).
</div>
</footer>
</body>
</html>
